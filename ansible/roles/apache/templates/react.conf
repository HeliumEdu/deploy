{% if frontend_ssl is undefined or not frontend_ssl %}
<VirtualHost *:80>
  ServerAdmin {{ email}}
  ServerName {{ url }}
  ServerAlias {{ alias_urls }}
{% else %}
<VirtualHost *:80>
  ServerAdmin {{ email}}
  ServerName {{ url }}
  ServerAlias {{ alias_urls }}

  RewriteEngine On
  RewriteRule ^/?(.*) https://%{SERVER_NAME}/$1 [R,L]
</VirtualHost>
<IfModule mod_ssl.c>
  <VirtualHost _default_:443>
    ServerAdmin {{ email }}
    ServerName {{ url }}
    ServerAlias {{ alias_urls }}
{% endif %}

    DocumentRoot {{ srv_dir }}

    {% if letsencrypt_ssl is defined and letsencrypt_ssl %}
    Include /etc/letsencrypt/options-ssl-apache.conf
    SSLCertificateFile /etc/letsencrypt/live/{{ url }}/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/{{ url }}/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf
    {% else %}
    SSLEngine On
    SSLCertificateFile /etc/apache2/ssl/apache.crt
    SSLCertificateKeyFile /etc/apache2/ssl/apache.key
    SSLCertificateChainFile /etc/apache2/ssl/apache.ca-bundle
    {% endif %}

    ErrorLog "/var/log/apache2/{{ url }}.error.log"
    CustomLog "/var/log/apache2/{{ url }}.access.log" combined

    # Serve React application
    <Directory "{{ srv_dir }}">
      RewriteEngine on
      # Don't rewrite files or directories
      RewriteCond %{REQUEST_FILENAME} -f [OR]
      RewriteCond %{REQUEST_FILENAME} -d
      RewriteRule ^ - [L]
      # Rewrite everything else to index.html to allow html5 state links
      RewriteRule ^ index.html [L]
    </Directory>

    # Pass certain URLs through to the backend
    ProxyPass /docs {{ platform_host_protocol }}{{ platform_host }}/docs
    ProxyPassReverse /docs {{ platform_host_protocol }}{{ platform_host }}/docs
    ProxyPass /admin {{ platform_host_protocol }}{{ platform_host }}/admin
    ProxyPassReverse /admin {{ platform_host_protocol }}{{ platform_host }}/admin
    <Location /(docs|admin)>
        Order allow,deny
        Allow from all
    </Location>
    {% endif %}
  </VirtualHost>
{% if frontend_ssl is defined and frontend_ssl %}
</IfModule>
{% endif %}

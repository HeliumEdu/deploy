name: "Deploy Legacy Frontend"

run-name: "Deploy legacy frontend v${{ inputs.version }}"

on:
  workflow_dispatch:
    inputs:
      version:
        type: string
        required: true
      environment:
        type: choice
        required: true
        default: prod
        options:
        - dev
        - prod
      run_cluster_tests:
        description: 'Run cluster tests before deploying'
        required: true
        type: boolean
        default: true
      cut_release:
        type: boolean
        required: true
        default: false
        description: "Cut the release tag for the `infra` repo. Usually only needed if manually re-deploying a \"Build and Deploy Release\" pipeline that failed."
  workflow_call:
    inputs:
      version:
        type: string
        required: true
      environment:
        type: string
        required: true
      run_cluster_tests:
        type: boolean
        required: true
      cut_release:
        type: boolean
        required: true

permissions:
  contents: read
  issues: none
  pull-requests: none

concurrency:
  group: "helium-infra-${{inputs.environment}}"

jobs:
  test:
    name: Test Release
    if: ${{ github.event.inputs.run_cluster_tests == 'true' }}

    env:
      FORCE_COLOR: 1
      PYTHONUNBUFFERED: 1
      PYTHONDONTWRITEBYTECODE: 1
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: us-east-1
      PLATFORM_EMAIL_HOST_USER: ${{ secrets.PLATFORM_EMAIL_HOST_USER }}
      PLATFORM_EMAIL_HOST_PASSWORD: ${{ secrets.PLATFORM_EMAIL_HOST_PASSWORD }}
      PLATFORM_TWILIO_ACCOUNT_SID: ${{ secrets.PLATFORM_TWILIO_ACCOUNT_SID }}
      PLATFORM_TWILIO_AUTH_TOKEN: ${{ secrets.PLATFORM_TWILIO_AUTH_TOKEN }}
      PLATFORM_TWILIO_SMS_FROM: ${{ vars.PLATFORM_TWILIO_SMS_FROM }}
      CI_AWS_S3_ACCESS_KEY_ID: ${{ secrets.CI_AWS_S3_ACCESS_KEY_ID }}
      CI_AWS_S3_SECRET_ACCESS_KEY: ${{ secrets.CI_AWS_S3_SECRET_ACCESS_KEY }}
      CI_TWILIO_RECIPIENT_PHONE_NUMBER: ${{ secrets.CI_TWILIO_RECIPIENT_PHONE_NUMBER }}

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python "3.12"
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install GitHub SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_KEY_GITHUB }}
          known_hosts: ${{ secrets.KNOWN_HOSTS_GITHUB }}
          if_key_exists: replace

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Get latest platform release version
        id: platform_version
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          VERSION=$(gh api repos/HeliumEdu/platform/tags --jq '[.[] | select(.name | test("^[0-9]+\\.[0-9]+\\.[0-9]+$"))][0].name')

          if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
            echo "Error: No version tags found in HeliumEdu/platform"
            exit 1
          fi

          TAG="${VERSION#v}"

          echo "Using latest platform version: ${VERSION} (tag: ${TAG})"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Set container environment variables
        env:
          PLATFORM_TAG: ${{ steps.platform_version.outputs.tag }}
          FRONTEND_TAG: ${{ inputs.version }}
        run: |
          echo "PLATFORM_RESOURCE_IMAGE=public.ecr.aws/heliumedu/helium/platform-resource:amd64-${PLATFORM_TAG}" >> $GITHUB_ENV
          echo "PLATFORM_API_IMAGE=public.ecr.aws/heliumedu/helium/platform-api:amd64-${PLATFORM_TAG}" >> $GITHUB_ENV
          echo "PLATFORM_WORKER_IMAGE=public.ecr.aws/heliumedu/helium/platform-worker:amd64-${PLATFORM_TAG}" >> $GITHUB_ENV
          echo "FRONTEND_IMAGE=public.ecr.aws/heliumedu/helium/frontend:legacy-amd64-${FRONTEND_TAG}" >> $GITHUB_ENV

      - name: Install dependencies
        run: make install

      - name: Run CI tests against release build
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 4
          retry_wait_seconds: 15
          max_attempts: 2
          command: FRONTEND_PROJECT=frontend-legacy PROJECT_APP_HOST=http://localhost:3000 make test-cluster

      - name: Dump Docker logs on failure
        if: failure()
        uses: jwalton/gh-docker-logs@v2

  release:
    name: Deploy Legacy Frontend
    needs: test
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')

    env:
      FORCE_COLOR: 1
      PYTHONUNBUFFERED: 1
      PYTHONDONTWRITEBYTECODE: 1
      FRONTEND_ROLLBAR_SERVER_ITEM_ACCESS_TOKEN: ${{ secrets.FRONTEND_ROLLBAR_SERVER_ITEM_ACCESS_TOKEN }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      ENVIRONMENT: ${{ inputs.environment }}
      VERSION: ${{ inputs.version }}

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python "3.12"
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install boto3 requests

      - name: Deploy frontend-legacy to S3
        run: python bin/trigger-frontend-legacy-release.py

      - name: Notify Rollbar of frontend deploy
        uses: rollbar/github-deploy-action@2.1.2
        with:
          environment: ${{ inputs.environment }}
          version: ${{ inputs.version }}
        env:
          ROLLBAR_ACCESS_TOKEN: ${{ secrets.FRONTEND_ROLLBAR_SERVER_ITEM_ACCESS_TOKEN }}
          ROLLBAR_USERNAME: ${{ github.actor }}
